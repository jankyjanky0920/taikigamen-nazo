<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è¬è§£ãæŒ‘æˆ¦</title>
  <link rel="stylesheet" href="style.css">
  <script src="data.js"></script>
</head>
<body>
  <div id="quiz-container"></div>

  <div id="modal-overlay" class="hidden">
    <div id="modal-content">
      <span id="modal-close">&times;</span>
      <div id="modal-body"></div>
      <button id="back-to-list-modal">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <script>
    function isDevEnabled() {
      return localStorage.getItem("devMode") === "true";
    }

    async function fetchServerStatus() {
      try {
        const res = await fetch("status.json", { cache: "no-store" });
        if (!res.ok) throw new Error("status.jsonãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
        return await res.json();
      } catch (err) {
        console.error(err);
        return {};
      }
    }

    async function getCurrentStatus(quiz) {
      const saved = localStorage.getItem(`status_${quiz.id}`);
      if (saved) return saved;

      const serverStatus = await fetchServerStatus();
      if (serverStatus[quiz.id]) return serverStatus[quiz.id];

      const startTime = new Date(quiz.startTime);
      const now = new Date();
      const diff = now - startTime;

      if (diff < 0) return "éå…¬é–‹";
      if (diff < 60 * 60 * 1000) return "å‡ºé¡Œ";
      if (diff < 24 * 60 * 60 * 1000) return "å‡ºé¡ŒçµŒé";
      return "å…¬é–‹";
    }

    function setStatus(quiz, newStatus) {
      localStorage.setItem(`status_${quiz.id}`, newStatus);
    }

    async function exportStatusJSON() {
      const allStatuses = {};
      quizzes.forEach(q => {
        const s = localStorage.getItem(`status_${q.id}`);
        if (s) allStatuses[q.id] = s;
      });

      const jsonData = JSON.stringify(allStatuses, null, 2);
      const token = localStorage.getItem("githubToken");
      if (!token) {
        alert("âš ï¸ GitHubãƒˆãƒ¼ã‚¯ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const owner = "jankyjanky0920";
      const repo = "jankyjanky0920/taikigamen-nazo";
      const path = "status.json";

      try {
        const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          headers: { Authorization: `token ${token}` }
        });
        const fileData = await getRes.json();
        const sha = fileData.sha;

        const updateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Update status.json from website",
            content: btoa(unescape(encodeURIComponent(jsonData))),
            sha: sha
          })
        });

        if (updateRes.ok) {
          alert("âœ… status.json ã‚’GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼");
        } else {
          const err = await updateRes.json();
          console.error(err);
          alert("âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      } catch (error) {
        console.error(error);
        alert("âŒ é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    const modalOverlay = document.getElementById("modal-overlay");
    const modalBody = document.getElementById("modal-body");
    const modalClose = document.getElementById("modal-close");
    const backToListModal = document.getElementById("back-to-list-modal");

    function showModal(content, options = {}) {
      modalBody.innerHTML = content;
      backToListModal.style.display = options.hideBackButton ? "none" : "inline-block";
      modalOverlay.classList.remove("hidden");
    }

    function hideModal() {
      modalOverlay.classList.add("hidden");
    }

    modalClose.onclick = hideModal;
    modalOverlay.onclick = e => {
      if (e.target === modalOverlay) hideModal();
    };
    backToListModal.onclick = () => {
      window.location.href = "index.html";
    };

    function renderQuiz(status, quiz) {
      const container = document.getElementById("quiz-container");

      if (status === "éå…¬é–‹") {
        container.innerHTML = "<p>ã“ã®å•é¡Œã¯ã¾ã éå…¬é–‹ã§ã™ã€‚</p>";
        return;
      }

      const checkDisabled = status === "éå…¬é–‹" ? "disabled" : "";
      const hintDisabled = status === "å‡ºé¡Œ" ? "disabled" : "";
      const giveupDisabled = status === "å…¬é–‹" ? "" : "disabled";

      container.innerHTML = `
        <h2>${quiz.title}</h2>
        <img src="${quiz.thumbnail}" alt="å•é¡Œç”»åƒ" class="problem-img">
        <input type="text" id="answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ›">
        <button id="check-btn" ${checkDisabled}>ç­”ãˆåˆã‚ã›</button>
        <button id="hint-btn" ${hintDisabled}>ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
        <button id="giveup-btn" ${giveupDisabled}>è«¦ã‚ã‚‹</button>
        <div style="margin-top:20px;">
          <button id="back-to-list">â† å•é¡Œä¸€è¦§ã«æˆ»ã‚‹</button>
        </div>
      `;

      document.getElementById("back-to-list").onclick = () => {
        window.location.href = "index.html";
      };

      const checkBtn = document.getElementById("check-btn");
      const hintBtn = document.getElementById("hint-btn");
      const giveupBtn = document.getElementById("giveup-btn");

      if (checkBtn) {
        checkBtn.onclick = () => {
          const userAnswer = document.getElementById("answer-input").value.trim();
          const normalize = str =>
            str.toLowerCase()
              .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
              .replace(/\s+/g, "");
          const normalizedUserAnswer = normalize(userAnswer);
          const isCorrect = quiz.answers.some(ans => normalize(ans) === normalizedUserAnswer);

          if (isCorrect) {
            showModal(`
              <h3>âœ… æ­£è§£ï¼</h3>
              <p>${quiz.answerText}</p>
              <img src="${quiz.answerImage}" alt="ç­”ãˆç”»åƒ" class="answer-img">
            `);
          } else {
            showModal(`<h3>âŒ ä¸æ­£è§£ï¼</h3><p>ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼</p>`, { hideBackButton: true });
          }
        };
      }

      if (hintBtn && !hintBtn.disabled) {
        hintBtn.onclick = () => {
          showModal(`
            <h3>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h3>
            <p>${quiz.hint}</p>
          `, { hideBackButton: true });
        };
      }

      if (giveupBtn && !giveupBtn.disabled) {
        giveupBtn.onclick = () => {
          showModal(`
            <h3>ğŸ˜¢ è«¦ã‚ã¾ã—ãŸã­â€¦</h3>
            <p>${quiz.answerText}</p>
            <img src="${quiz.answerImage}" alt="ç­”ãˆç”»åƒ" class="answer-img">
          `);
        };
      }
    }

    function showDevPanel(quiz, status) {
      const devPanel = document.createElement("div");
      devPanel.style.margin = "15px";
      devPanel.style.padding = "10px";
      devPanel.style.border = "2px dashed #888";
      devPanel.style.background = "#f0f0f0";
      devPanel.innerHTML = `
        <strong>ğŸ›  é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</strong><br>
        ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="dev-status">${status}</span><br>
        <select id="dev-status-select">
          <option value="éå…¬é–‹">éå…¬é–‹</option>
          <option value="å‡ºé¡Œ">å‡ºé¡Œ</option>
          <option value="å‡ºé¡ŒçµŒé">å‡ºé¡ŒçµŒé</option>
          <option value="å…¬é–‹">å…¬é–‹</option>
        </select>
        <button id="dev-apply">å¤‰æ›´</button>
        <button id="dev-reset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="export-json">ğŸ’¾ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      `;
      document.body.prepend(devPanel);

      document.getElementById("dev-apply").onclick = () => {
        const newStatus = document.getElementById("dev-status-select").value;
        setStatus(quiz, newStatus);
        alert(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        renderQuiz(newStatus, quiz);
        document.getElementById("dev-status").textContent = newStatus;
      };

      document.getElementById("dev-reset").onclick = () => {
        localStorage.removeItem(`status_${quiz.id}`);
        alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆæ™‚é–“çµŒéãƒ«ãƒ¼ãƒ«ã«æˆ»ã‚Šã¾ã™ï¼‰");
        initQuiz();
      };

      document.getElementById("export-json").onclick = exportStatusJSON;
    }

    async function initQuiz() {
      const params = new URLSearchParams(window.location.search);
      const quizId = parseInt(params.get("id"));
      const quiz = quizzes.find(q => q.id === quizId);
      const isDevMode = isDevEnabled();

      if (!quiz) {
        document.getElementById("quiz-container").innerHTML = "<p>å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      const status = await getCurrentStatus(quiz);
      renderQuiz(status, quiz);

      if (isDevMode) showDevPanel(quiz, status);
    }

    window.addEventListener("DOMContentLoaded", initQuiz);
  </script>
</body>
</html>
